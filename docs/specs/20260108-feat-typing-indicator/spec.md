# Feature: Typing Indicator

## Overview

ユーザーがメッセージを送信した後、ボットが応答を生成している間、LINE上でタイピングインジケーター（ローディングアニメーション）を表示する。

## Background & Purpose

現在、ユーザーがメッセージを送信してからボットが応答するまで2〜10秒程度かかる（Gemini APIによる応答生成のため）。この間、ユーザーには何のフィードバックもなく、ボットが動作しているかどうかわからない。

タイピングインジケーターを表示することで：
- ボットがメッセージを受け取り、処理中であることをユーザーに伝える
- ユーザー体験を向上させる
- 応答待ち時間のストレスを軽減する

## Out of Scope

- グループチャットやマルチパーソンチャットでのタイピングインジケーター表示（LINE APIの制限により1:1チャットのみ対応）
- ローディング時間のカスタマイズ設定（管理画面等での設定変更）
- 複数回のローディングインジケーター更新（LINEの仕様により、進行中のインジケーターに対する追加リクエストは時間を上書きするのみ）

## Requirements

### Functional Requirements

- [ ] FR-001: メッセージ受信後、応答生成処理の開始前にLINEのローディングインジケーターAPIを呼び出す
- [ ] FR-002: ローディングインジケーターは1:1チャット（UserSource）でのみ呼び出す。グループチャット（GroupSource）やルームチャット（RoomSource）では呼び出さない
- [ ] FR-003: ボットからの応答メッセージ送信時に、ローディングインジケーターは自動的に消える（LINE APIの仕様）
- [ ] FR-004: ローディングインジケーターAPI呼び出しが失敗しても、メッセージ処理は継続する
- [ ] FR-005: ローディングインジケーターの表示時間（loadingSeconds）はLLMタイムアウト設定値を使用する（5〜60秒の範囲内にクランプ）

### Non-Functional Requirements

- [ ] NFR-001: ローディングインジケーターAPI呼び出しは非同期で行い、メッセージ処理をブロックしない
- [ ] NFR-002: ローディングインジケーターAPI呼び出しのエラーはWARNレベルでログに記録し、ユーザーにはエラーを表示しない

## Acceptance Criteria

### AC-001: 1:1チャットでローディングインジケーターが表示される [FR-001, FR-002, FR-005]

- **Given**: ユーザーがボットと1:1チャットをしている
- **When**: ユーザーがテキストメッセージを送信する
- **Then**:
  - LINE上でローディングアニメーションが表示される
  - ボットが応答を返すまでアニメーションが継続する
  - ローディング時間はLLMタイムアウト設定値に基づく

### AC-002: 応答送信でローディングインジケーターが消える [FR-003]

- **Given**: ローディングインジケーターが表示されている
- **When**: ボットが応答メッセージを送信する
- **Then**:
  - ローディングインジケーターが自動的に消える
  - 応答メッセージが表示される
  - ユーザーにエラーメッセージは表示されない

### AC-003: グループチャットではローディングインジケーターを呼び出さない [FR-002]

- **Given**: ユーザーがグループチャット（GroupSourceまたはRoomSource）でボットにメンションしている
- **When**: ユーザーがメッセージを送信する
- **Then**:
  - ローディングインジケーターAPIは呼び出されない
  - メッセージ処理は通常通り完了する

### AC-004: API呼び出し失敗時もメッセージ処理は継続 [FR-004, NFR-002]

- **Given**: ローディングインジケーターAPIが利用不可（ネットワークエラー等）
- **When**: ユーザーがメッセージを送信する
- **Then**:
  - エラーがWARNレベルでログに記録される
  - メッセージ処理は中断されずに継続する
  - ユーザーには通常通り応答が返される

### AC-005: API呼び出しがメッセージ処理をブロックしない [NFR-001]

- **Given**: ユーザーがメッセージを送信する
- **When**: ローディングインジケーターAPIが呼び出される
- **Then**:
  - メッセージ処理の開始がAPI呼び出しの完了を待たない
  - ローディングインジケーターAPIのレスポンスが遅延しても、メッセージ処理は正常に完了する

## Change History

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2026-01-08 | 1.0 | Initial version | - |
| 2026-01-08 | 1.1 | Address spec-reviewer feedback: add loadingSeconds parameter (FR-005), clarify source type definitions, make acceptance criteria testable | - |
| 2026-01-08 | 1.2 | Remove implementation details (specific function/layer names) per spec guidelines - leave to /design phase | - |
