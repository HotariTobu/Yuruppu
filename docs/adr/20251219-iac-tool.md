# ADR: IaC Tool Selection

> Date: 2025-12-19
> Status: **Adopted**

## Context

The deployable-server spec (FR-005) requires managing GCP resources with Infrastructure as Code (IaC). We need to decide which tool to use for managing:
- Artifact Registry
- Cloud Build triggers
- IAM roles and service accounts
- Secret Manager
- Cloud Run

## Decision Drivers

- Minimize Google Cloud Console operations
- Solo developer workflow (simple state management)
- Complete GCP resource coverage
- Long-term viability and open-source sustainability
- Low setup complexity

## Options Considered

- **Option 1:** OpenTofu
- **Option 2:** Terraform
- **Option 3:** Pulumi
- **Option 4:** gcloud CLI scripts

## Evaluation

Note: Criteria adapted for infrastructure tooling (not Go libraries).

| Criterion | Weight | OpenTofu | Terraform | Pulumi | gcloud |
|-----------|--------|----------|-----------|--------|--------|
| Setup Complexity | 20% | 5 (1.00) | 4 (0.80) | 4 (0.80) | 5 (1.00) |
| Learning Curve | 20% | 5 (1.00) | 4 (0.80) | 4 (0.80) | 3 (0.60) |
| GCP Coverage | 25% | 5 (1.25) | 5 (1.25) | 5 (1.25) | 5 (1.25) |
| State Management | 15% | 5 (0.75) | 4 (0.60) | 4 (0.60) | 1 (0.15) |
| Documentation | 10% | 4 (0.40) | 5 (0.50) | 4 (0.40) | 4 (0.40) |
| Long-term Viability | 10% | 5 (0.50) | 3 (0.30) | 4 (0.40) | 5 (0.50) |
| **Total** | 100% | **4.90** | **4.25** | **4.25** | **3.90** |

### License Comparison

| Tool | License | Commercial Use Risk |
|------|---------|---------------------|
| OpenTofu | MPL 2.0 | None (Linux Foundation) |
| Terraform | BSL 1.1 | Potential restrictions |
| Pulumi | Apache 2.0 | None |
| gcloud | Proprietary | None (free tool) |

## Decision

Adopt **OpenTofu**.

## Rationale

1. **CNCF backing**: OpenTofu is a CNCF Sandbox project under Linux Foundation governance, ensuring vendor-neutral long-term maintenance

2. **License safety**: MPL 2.0 license with no commercial use restrictions, unlike Terraform's BSL 1.1 which could restrict competitive use

3. **Built-in state encryption**: OpenTofu 1.7+ supports client-side encryption of state files before uploading to GCS, a feature Terraform lacks

4. **Terraform compatibility**: Uses identical HCL syntax, meaning all Terraform tutorials, examples, and modules work directly

5. **Superior state management**: GCS backend with built-in encryption, versioning, and locking - all free (no Terraform Cloud required)

6. **Active development**: 27k+ GitHub stars, 350k+ weekly downloads, regular releases (v1.11.1 as of Dec 2025)

While Terraform has slightly better documentation ecosystem, OpenTofu's open-source governance and built-in encryption make it the safer long-term choice for this project.

## Consequences

**Positive:**
- Complete GCP resource coverage
- No licensing concerns for commercial use
- Client-side state encryption included
- Can use all existing Terraform learning resources
- Zero cost (no Terraform Cloud needed)
- Linux Foundation governance prevents vendor lock-in

**Negative:**
- Slightly fewer OpenTofu-specific tutorials (mitigated by Terraform compatibility)
- Team must learn HCL syntax (minimal learning curve: ~1-2 days)
- Must create GCS bucket for state manually (one-time bootstrap)

**Risks:**
- **Risk**: OpenTofu-specific features may diverge from Terraform
- **Mitigation**: Project uses only stable, shared features; migration to Terraform remains trivial if needed

## Confirmation

Success criteria:
- `tofu init` completes without errors
- `tofu plan` shows expected resources
- All GCP resources can be created/updated via `tofu apply`
- State file stored securely in GCS with encryption

## Related Decisions

- [20251218-container-build.md](./20251218-container-build.md) - Uses ko for image builds
- [20251218-cicd.md](./20251218-cicd.md) - Uses Cloud Build for CI/CD

## Resources

| Tool | Documentation | Repository |
|------|---------------|------------|
| OpenTofu | [opentofu.org/docs](https://opentofu.org/docs/) | [opentofu/opentofu](https://github.com/opentofu/opentofu) |
| Terraform | [terraform.io/docs](https://developer.hashicorp.com/terraform/docs) | [hashicorp/terraform](https://github.com/hashicorp/terraform) |
| Pulumi | [pulumi.com/docs](https://www.pulumi.com/docs/) | [pulumi/pulumi](https://github.com/pulumi/pulumi) |

## Sources

- [OpenTofu CNCF Project Page](https://www.cncf.io/projects/opentofu/)
- [OpenTofu vs Terraform Comparison (Spacelift)](https://spacelift.io/blog/opentofu-vs-terraform)
- [OpenTofu State Encryption](https://spacelift.io/blog/opentofu-state-encryption)
- [OpenTofu GCS Backend Documentation](https://opentofu.org/docs/language/settings/backends/gcs/)
- [Getting Started with OpenTofu - Linux Foundation](https://training.linuxfoundation.org/express-learning/getting-started-with-opentofu-lfel1009/)
