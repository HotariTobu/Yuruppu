# ADR: CI/CD Strategy

> Date: 2025-12-18
> Status: **Adopted**

## Context

The deployable-server spec (FR-005) mentions CI/CD configuration should be decided in the design phase. We need automated deployment when code is pushed to the main branch.

## Decision Drivers

- Native Cloud Run integration
- GitHub repository (project is hosted on GitHub)
- Minimal configuration
- Generous free tier
- Secret management for LINE credentials

## Options Considered

- **Option 1:** Google Cloud Build
- **Option 2:** GitHub Actions
- **Option 3:** Manual deployment only (`gcloud run deploy --source`)

## Evaluation

| Criterion | Weight | Cloud Build | GitHub Actions | Manual Only |
|-----------|--------|-------------|----------------|-------------|
| Functional Fit | 25% | 4 (1.00) | 5 (1.25) | 3 (0.75) |
| Go Compatibility | 20% | 5 (1.00) | 5 (1.00) | 5 (1.00) |
| Lightweight | 15% | 4 (0.60) | 4 (0.60) | 5 (0.75) |
| Security | 15% | 4 (0.60) | 4 (0.60) | 4 (0.60) |
| Documentation | 15% | 4 (0.60) | 5 (0.75) | 5 (0.75) |
| Ecosystem | 10% | 5 (0.50) | 5 (0.50) | 3 (0.30) |
| **Total** | 100% | **4.30** | **4.70** | **4.15** |

### Free Tier Comparison

| Option | Free Tier |
|--------|-----------|
| Cloud Build | 120 minutes/day |
| GitHub Actions | 2,000 minutes/month |
| Manual | N/A (uses Cloud Build under the hood) |

## Decision

Adopt **Google Cloud Build**.

## Rationale

1. **Native GCP integration**: Cloud Build has first-class Cloud Run support with direct deployment steps

2. **Secret Manager integration**: LINE credentials can be stored in Secret Manager and accessed directly in builds

3. **Generous free tier**: 120 minutes/day is more than enough for this project (typical build: 1-2 minutes)

4. **ko support**: Cloud Build works well with ko for image builds

5. **Single platform**: Keeps all infrastructure in GCP (Cloud Run, Secret Manager, Cloud Build)

While GitHub Actions scored slightly higher (4.70 vs 4.30), Cloud Build keeps all deployment infrastructure within GCP, simplifying secret management and reducing context switching between platforms.

## Consequences

**Positive:**
- Automated deployment on push to main
- Native Secret Manager integration
- Centralized GCP infrastructure
- 120 minutes/day free tier
- Direct Cloud Run deployment support

**Negative:**
- IAM setup required (Cloud Build service account permissions)
- GCP-specific knowledge required
- Cannot test builds locally

**Risks:**
- **Risk**: IAM permission errors during setup
- **Mitigation**: Document required roles in README

## Configuration

### cloudbuild.yaml (with ko)

```yaml
steps:
  # Install ko
  - name: 'golang:1.23'
    entrypoint: 'bash'
    args:
      - '-c'
      - 'go install github.com/google/ko@latest'

  # Build and push with ko
  - name: 'golang:1.23'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        export KO_DOCKER_REPO=asia-northeast1-docker.pkg.dev/$PROJECT_ID/yuruppu
        /go/bin/ko build ./cmd/server --bare -t $SHORT_SHA -t latest

  # Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'yuruppu'
      - '--image=asia-northeast1-docker.pkg.dev/$PROJECT_ID/yuruppu:$SHORT_SHA'
      - '--region=asia-northeast1'
      - '--platform=managed'
      - '--update-secrets=LINE_CHANNEL_SECRET=LINE_CHANNEL_SECRET:latest'
      - '--update-secrets=LINE_CHANNEL_ACCESS_TOKEN=LINE_CHANNEL_ACCESS_TOKEN:latest'

options:
  logging: CLOUD_LOGGING_ONLY
```

### Required IAM Roles

Cloud Build service account needs:
- `roles/run.admin`
- `roles/iam.serviceAccountUser`
- `roles/artifactregistry.writer`
- `roles/secretmanager.secretAccessor`

## Confirmation

Success criteria:
- Push to main triggers automatic build
- Build completes in < 3 minutes
- Cloud Run service is updated automatically

## Related Decisions

- [20251218-container-build.md](./20251218-container-build.md) - Uses ko for image builds

## Resources

| Option | Documentation |
|--------|---------------|
| Cloud Build | [Cloud Build Docs](https://cloud.google.com/build/docs) |
| GitHub Actions | [GitHub Actions Docs](https://docs.github.com/en/actions) |
| ko + Cloud Build | [ko Deployment Docs](https://ko.build/deployment/) |

## Sources

- [Deploying to Cloud Run using Cloud Build](https://cloud.google.com/build/docs/deploying-builds/deploy-cloud-run)
- [Cloud Build Pricing](https://cloud.google.com/build/pricing)
- [Use secrets from Secret Manager](https://cloud.google.com/build/docs/securing-builds/use-secrets)
- [ko Deployment Documentation](https://ko.build/deployment/)
